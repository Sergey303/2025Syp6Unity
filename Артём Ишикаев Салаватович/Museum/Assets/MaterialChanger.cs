using UnityEngine;
using System.Net.Http;
using System.Threading.Tasks;
using System;
using System.Collections;
using System.Xml.Linq;
using System.Linq;
using System.Net;
using static System.Net.WebRequestMethods;
using UnityEngine.Networking;
using System.Collections.Generic;

public class ApiResponse
{
    public string RandomUrl { get; set; }
    public string Status { get; set; }
}



public class MaterialChanger : MonoBehaviour
{
    public string PhotoUrl;
    public SpriteRenderer Image1;
    public Texture2D loadingPicture;
    public int picturesNumber;
    public List<Texture2D> textures;

    public List<Texture2D> ImportPicture(string name)
    {

        
        using (var client = new HttpClient())
        {

            
            // Replace with your API endpoint
            string apiUrl = "http://syp.iis.nsk.su/sypwebapi/xml/search/" + name;
            HttpResponseMessage response = client.GetAsync(apiUrl).GetAwaiter().GetResult();

            string Response = response.Content.ReadAsStringAsync().GetAwaiter().GetResult();

            XElement XResp = XElement.Parse(Response);

            string[] records = XResp.Elements("record").Select(x => x.Attribute("id").Value).Take(5).ToArray();

            string[] personPhotos = new string[records.Length];
            string photoSites;
            foreach (string id in records)
            {
                photoSites = "http://syp.iis.nsk.su/Sypwebapi/xml/tree2/" + id;
                HttpResponseMessage photoURLs = client.GetAsync(photoSites).GetAwaiter().GetResult();
                string PhotoURLs = photoURLs.Content.ReadAsStringAsync().GetAwaiter().GetResult();

                var XPhotoes = XElement.Parse(PhotoURLs);
                var potomki_inversa = XPhotoes.Elements("inverse").First().Descendants();
                var filtrovanye_potomki = potomki_inversa.Where(x => x.Attribute("pred")?.Value == "uri");
                string[] inverse5 = filtrovanye_potomki.Select(x => x?.Value).Take(5).ToArray();



                foreach (string rawPhotoUrl in inverse5)
                {
                    PhotoUrl = "http://syp.iis.nsk.su/SypWebApi/photo?uri=" + rawPhotoUrl + "&s=normal";
                    StartCoroutine(Change_Photo(PhotoUrl));

                }
            }
        }
        return textures;
    }
    // Start is called before the first frame update
    void Start()
    {
        ImportPicture("Ишикаев");
    }
    public IEnumerator Change_Photo(string Url)
    {
        UnityWebRequest www = UnityWebRequestTexture.GetTexture(Url);
        yield return www.SendWebRequest();
        Texture2D texture2D = DownloadHandlerTexture.GetContent(www);
        textures.Add(texture2D);
        /*
        Rect rec = new Rect(0, 0, texture2D.width, texture2D.height);
        Image1.sprite = Sprite.Create(texture2D, rec, new Vector2(0.5f, 0.5f));
        */
    }

    // Update is called once per frame
    void Update()
    {
    }
}
/*
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Лосось
Втомате
*/
